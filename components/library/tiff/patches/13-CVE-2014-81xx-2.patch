From a42c3be7780cc90beef9ffd14255059baef7413a Mon Sep 17 00:00:00 2001
From: erouault <erouault>
Date: Sun, 21 Dec 2014 16:28:37 +0000
Subject: [PATCH] * tools/tiffcp.c: fix crash when converting YCbCr
 JPEG-compressed to none. Based on patch by Tomasz Buchert
 (http://bugzilla.maptools.org/show_bug.cgi?id=2480) Description: fix for
 Debian bug #741451 tiffcp crashes when converting JPEG-encoded TIFF to a
 different encoding (like none or lzw). For example this will probably fail:
 tiffcp -c none jpeg_encoded_file.tif output.tif The reason is that when the
 input file contains JPEG data, the tiffcp code forces conversion to RGB
 space. However, the output normally inherits YCbCr subsampling parameters
 from the input, which leads to a smaller working buffer than necessary. The
 buffer is subsequently overrun inside cpStripToTile() (called from
 writeBufferToContigTiles). Note that the resulting TIFF file would be
 scrambled even if tiffcp wouldn't crash, since the output file would contain
 RGB data intepreted as subsampled YCbCr values. This patch fixes the problem
 by forcing RGB space on the output TIF if the input is JPEG-encoded and
 output is *not* JPEG-encoded. Author: Tomasz Buchert
 <tomasz.buchert@inria.fr>

---
 ChangeLog      | 21 +++++++++++++++++++++
 tools/tiffcp.c |  6 ++++++
 2 files changed, 27 insertions(+)

Index: tiff-4.0.3/tools/tiffcp.c
===================================================================
--- tiff-4.0.3.orig/tools/tiffcp.c	2015-01-29 09:35:31.797162827 -0500
+++ tiff-4.0.3/tools/tiffcp.c	2015-01-29 09:35:31.793162794 -0500
@@ -629,6 +629,12 @@
 		TIFFSetField(out, TIFFTAG_PHOTOMETRIC,
 		    samplesperpixel == 1 ?
 		    PHOTOMETRIC_LOGL : PHOTOMETRIC_LOGLUV);
+	else if (input_compression == COMPRESSION_JPEG &&
+			 samplesperpixel == 3 ) {
+		/* RGB conversion was forced above
+		hence the output will be of the same type */
+		TIFFSetField(out, TIFFTAG_PHOTOMETRIC, PHOTOMETRIC_RGB);
+	}
 	else
 		CopyTag(TIFFTAG_PHOTOMETRIC, 1, TIFF_SHORT);
 	if (fillorder != 0)
